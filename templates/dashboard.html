<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICT Infrastructure Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f7fa;
            color: #2c3e50;
        }
        
        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #22c0f5 100%);
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .navbar h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .navbar .subtitle {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-top: 0.25rem;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
        }
        
        .stat-card .icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        
        .stat-card .label {
            font-size: 0.875rem;
            color: #64748b;
            margin-bottom: 0.5rem;
        }
        
        .stat-card .value {
            font-size: 2rem;
            font-weight: 700;
            color: #1e293b;
        }
        
        .stat-card .trend {
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }
        
        .controls {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .controls h3 {
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }
        
        .region-buttons {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }
        
        .region-btn {
            padding: 0.5rem 1rem;
            border: 2px solid #e2e8f0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .region-btn:hover {
            border-color: #667eea;
            color: #667eea;
        }
        
        .region-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .chart-container h3 {
            margin-bottom: 1rem;
            font-size: 1.1rem;
            color: #1e293b;
        }
        
        .chart-canvas {
            max-height: 300px;
        }
        
        .map-container {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
        }
        
        #map {
            height: 500px;
            border-radius: 8px;
        }
        
        .alerts-container {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
        }
        
        .alerts-container h3 {
            margin-bottom: 1rem;
        }
        
        .alert-item {
            padding: 1rem;
            border-left: 4px solid;
            margin-bottom: 0.75rem;
            border-radius: 4px;
            background: #f8fafc;
        }
        
        .alert-item.critical {
            border-left-color: #ef4444;
            background: #fef2f2;
        }
        
        .alert-item.warning {
            border-left-color: #f59e0b;
            background: #fffbeb;
        }
        
        .alert-item.info {
            border-left-color: #3b82f6;
            background: #eff6ff;
        }
        
        .alert-item .alert-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }
        
        .alert-item .alert-title {
            font-weight: 600;
            font-size: 0.95rem;
        }
        
        .alert-item .alert-time {
            font-size: 0.85rem;
            color: #64748b;
        }
        
        .alert-item .alert-message {
            font-size: 0.9rem;
            color: #475569;
        }
        
        .alert-item .alert-location {
            font-size: 0.85rem;
            color: #64748b;
            margin-top: 0.5rem;
        }

        .news-ticker-container {
            position: relative;
            background: linear-gradient(90deg, #667eea 0%, #22c0f5 100%);
            color: white;
            border-radius: 12px;
            overflow: hidden;
            margin-top: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
        }

        .news-ticker-title {
            font-weight: 600;
            padding: 0.75rem 1rem;
            background: rgba(0,0,0,0.15);
            border-right: 1px solid rgba(255,255,255,0.2);
            flex-shrink: 0;
        }

        .news-ticker {
            white-space: nowrap;
            overflow: hidden;
            position: relative;
            flex-grow: 1;
        }

        .news-ticker span {
            display: inline-block;
            padding-left: 100%;
            animation: ticker-scroll 20s linear infinite;
        }

        .news-ticker a {
            color: #fff;
            text-decoration: none;
            font-weight: 500;
            margin-right: 2rem;
        }

        .news-ticker a:hover {
            text-decoration: underline;
        }

        @keyframes ticker-scroll {
            0% { transform: translateX(0); }
            100% { transform: translateX(-100%); }
        }
        
        .loading {
            text-align: center;
            padding: 3rem;
            color: #64748b;
        }
        
        .spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }
        .snmp-monitoring-container {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    margin-bottom: 2rem;
}

.snmp-monitoring-container h3 {
    margin-bottom: 0.5rem;
    font-size: 1.1rem;
}

.snmp-description {
    color: #64748b;
    font-size: 0.9rem;
    margin-bottom: 1.5rem;
}

.snmp-input-form {
    display: flex;
    gap: 0.75rem;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
}

.snmp-input {
    flex: 1;
    min-width: 200px;
    padding: 0.75rem;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    font-size: 0.9rem;
    transition: border-color 0.2s;
}

.snmp-input:focus {
    outline: none;
    border-color: #667eea;
}

.snmp-query-btn {
    padding: 0.75rem 1.5rem;
    background: linear-gradient(135deg, #667eea 0%, #22c0f5 100%);
    color: white;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
}

.snmp-query-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

.snmp-query-btn:active {
    transform: translateY(0);
}

.snmp-results {
    margin-top: 1.5rem;
}

.snmp-card {
    background: #f8fafc;
    border-radius: 8px;
    padding: 1.25rem;
    margin-bottom: 1rem;
}

.snmp-card h4 {
    margin-bottom: 1rem;
    font-size: 1rem;
    color: #1e293b;
}

.snmp-info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 0.75rem;
}

.snmp-info-item {
    padding: 0.75rem;
    background: white;
    border-radius: 6px;
    border-left: 3px solid #667eea;
}

.snmp-info-label {
    font-size: 0.75rem;
    color: #64748b;
    margin-bottom: 0.25rem;
    text-transform: uppercase;
    font-weight: 600;
}

.snmp-info-value {
    font-size: 0.95rem;
    color: #1e293b;
    word-break: break-all;
}

.snmp-metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 1rem;
}

.snmp-metric {
    text-align: center;
    padding: 1rem;
}

.metric-value {
    font-size: 3rem;
    font-weight: 700;
    color: #667eea;
    margin-bottom: 0.5rem;
}

.metric-label {
    font-size: 0.9rem;
    color: #64748b;
}

.snmp-interface-info {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
}

.interface-stat {
    text-align: center;
    padding: 0.75rem;
    background: white;
    border-radius: 6px;
}

.interface-stat-label {
    font-size: 0.75rem;
    color: #64748b;
    margin-bottom: 0.5rem;
    text-transform: uppercase;
}

.interface-stat-value {
    font-size: 1.25rem;
    font-weight: 600;
    color: #1e293b;
}

.status-indicator {
    display: inline-block;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-right: 0.5rem;
}

.status-indicator.up {
    background: #10b981;
    box-shadow: 0 0 8px rgba(16, 185, 129, 0.5);
}

.status-indicator.down {
    background: #ef4444;
    box-shadow: 0 0 8px rgba(239, 68, 68, 0.5);
}

.snmp-error {
    padding: 1rem;
    background: #fef2f2;
    border-left: 4px solid #ef4444;
    border-radius: 4px;
    color: #991b1b;
}
    </style>
</head>
<body>
    <div class="navbar">
        <h1>🌍 ICT Infrastructure Dashboard</h1>
        <div class="subtitle">Global Network Monitoring & Analytics Platform</div>
    </div>
    
    <div class="container">
        <div class="stats-grid" id="statsGrid">
            <div class="loading">
                <div class="spinner"></div>
                <p>Loading statistics...</p>
            </div>
        </div>
        
        <div class="controls">
            <h3>Filter by Region</h3>
            <div class="region-buttons">
                <button class="region-btn active" onclick="filterRegion('all')">All Regions</button>
                <button class="region-btn" onclick="filterRegion('Africa')">Africa</button>
                <button class="region-btn" onclick="filterRegion('Asia-Pacific')">Asia-Pacific</button>
                <button class="region-btn" onclick="filterRegion('Europe-CIS')">Europe & CIS</button>
                <button class="region-btn" onclick="filterRegion('Latin America')">Latin America</button>
            </div>
        </div>
        
        <div class="map-container">
            <h3>📍 Global Office Locations</h3>
            <div id="map"></div>
        </div>
        
        <div class="charts-grid">
            <div class="chart-container">
                <h3>📊 Performance Trends (7 Days)</h3>
                <canvas id="performanceChart" class="chart-canvas"></canvas>
            </div>
            
            <div class="chart-container">
                <h3>🔧 Device Type Distribution</h3>
                <canvas id="deviceTypeChart" class="chart-canvas"></canvas>
            </div>
            
            <div class="chart-container">
                <h3>🌐 Regional Health Scores</h3>
                <canvas id="regionalChart" class="chart-canvas"></canvas>
            </div>
            
            <div class="chart-container">
                <h3>⚡ Network Performance</h3>
                <canvas id="networkChart" class="chart-canvas"></canvas>
            </div>
        </div>
        <!-- SNMP Real Device Monitoring Section -->
<div class="snmp-monitoring-container">
    <h3>🔧 SNMP Device Monitoring</h3>
    <p class="snmp-description">Monitor real network devices using SNMP protocol</p>
    
    <!-- Input Form -->
    <div class="snmp-input-form">
        <input type="text" 
               id="snmpDeviceIP" 
               placeholder="Enter device IP (e.g., 192.168.1.1)"
               class="snmp-input">
        <input type="text" 
               id="snmpCommunity" 
               placeholder="Community string (default: public)"
               class="snmp-input"
               value="public">
        <button onclick="querySnmpDevice()" class="snmp-query-btn">Query Device</button>
        <button onclick="loadDemoData()" class="snmp-query-btn" style="background: #10b981;">
        Load Demo Data
    </button>
    </div>
    
    <!-- Results Display -->
    <div id="snmpResults" class="snmp-results" style="display: none;">
        <!-- Device Info -->
        <div class="snmp-card">
            <h4>📋 Device Information</h4>
            <div id="snmpDeviceInfo" class="snmp-info-grid">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Querying device...</p>
                </div>
            </div>
        </div>
        
        <!-- CPU & Memory -->
        <div class="snmp-metrics-grid">
            <div class="snmp-card">
                <h4>💻 CPU Usage</h4>
                <div id="snmpCpu" class="snmp-metric">
                    <div class="metric-value">--</div>
                    <div class="metric-label">Percentage</div>
                </div>
            </div>
            
            <div class="snmp-card">
                <h4>💾 Memory Usage</h4>
                <div id="snmpMemory" class="snmp-metric">
                    <div class="metric-value">--</div>
                    <div class="metric-label">Percentage</div>
                </div>
            </div>
        </div>
        
        <!-- Interface Status -->
        <div class="snmp-card">
            <h4>🌐 Network Interface</h4>
            <div id="snmpInterface" class="snmp-interface-info">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
    </div>
</div>


<script>
async function querySnmpDevice() {
    const ip = document.getElementById('snmpDeviceIP').value.trim();
    const community = document.getElementById('snmpCommunity').value.trim() || 'public';
    
    if (!ip) {
        alert('Please enter a device IP address');
        return;
    }
    
    // Show results section
    const resultsDiv = document.getElementById('snmpResults');
    resultsDiv.style.display = 'block';
    
    // Reset displays
    document.getElementById('snmpDeviceInfo').innerHTML = '<div class="loading"><div class="spinner"></div><p>Querying device...</p></div>';
    document.getElementById('snmpCpu').innerHTML = '<div class="metric-value">--</div><div class="metric-label">Querying...</div>';
    document.getElementById('snmpMemory').innerHTML = '<div class="metric-value">--</div><div class="metric-label">Querying...</div>';
    document.getElementById('snmpInterface').innerHTML = '<div class="loading"><div class="spinner"></div></div>';
    
    try {
        // Query device info
        const infoResponse = await fetch(`${API_BASE}/snmp/device/${ip}/info?community=${community}`);
        
        if (!infoResponse.ok) {
            throw new Error('Device not reachable or SNMP not configured');
        }
        
        const infoData = await infoResponse.json();
        renderDeviceInfo(infoData);
        
        // Query CPU (Cisco devices)
        try {
            const cpuResponse = await fetch(`${API_BASE}/snmp/device/${ip}/cpu?community=${community}`);
            if (cpuResponse.ok) {
                const cpuData = await cpuResponse.json();
                renderCpuInfo(cpuData);
            } else {
                document.getElementById('snmpCpu').innerHTML = '<div class="metric-value">N/A</div><div class="metric-label">Not available</div>';
            }
        } catch (e) {
            document.getElementById('snmpCpu').innerHTML = '<div class="metric-value">N/A</div><div class="metric-label">Not supported</div>';
        }
        
        // Query Memory (Cisco devices)
        try {
            const memResponse = await fetch(`${API_BASE}/snmp/device/${ip}/memory?community=${community}`);
            if (memResponse.ok) {
                const memData = await memResponse.json();
                renderMemoryInfo(memData);
            } else {
                document.getElementById('snmpMemory').innerHTML = '<div class="metric-value">N/A</div><div class="metric-label">Not available</div>';
            }
        } catch (e) {
            document.getElementById('snmpMemory').innerHTML = '<div class="metric-value">N/A</div><div class="metric-label">Not supported</div>';
        }
        
        // Query Interface
        try {
            const intResponse = await fetch(`${API_BASE}/snmp/device/${ip}/interface/1?community=${community}`);
            if (intResponse.ok) {
                const intData = await intResponse.json();
                renderInterfaceInfo(intData);
            } else {
                document.getElementById('snmpInterface').innerHTML = '<p style="text-align:center;color:#64748b;">Interface data not available</p>';
            }
        } catch (e) {
            document.getElementById('snmpInterface').innerHTML = '<p style="text-align:center;color:#64748b;">Interface data not supported</p>';
        }
        
    } catch (error) {
        console.error('SNMP Query Error:', error);
        document.getElementById('snmpResults').innerHTML = `
            <div class="snmp-error">
                <strong>⚠️ Connection Failed</strong><br>
                ${error.message}<br><br>
                <strong>Troubleshooting:</strong>
                <ul style="margin-top: 0.5rem; margin-left: 1.5rem;">
                    <li>Verify the device IP is correct and reachable</li>
                    <li>Ensure SNMP is enabled on the device</li>
                    <li>Check the community string (default: public)</li>
                    <li>Verify firewall allows UDP port 161</li>
                </ul>
            </div>
        `;
    }
}

function renderDeviceInfo(data) {
    const infoDiv = document.getElementById('snmpDeviceInfo');
    infoDiv.innerHTML = `
        <div class="snmp-info-item">
            <div class="snmp-info-label">Hostname</div>
            <div class="snmp-info-value">${data.hostname || 'Unknown'}</div>
        </div>
        <div class="snmp-info-item">
            <div class="snmp-info-label">IP Address</div>
            <div class="snmp-info-value">${data.host}</div>
        </div>
        <div class="snmp-info-item">
            <div class="snmp-info-label">Uptime</div>
            <div class="snmp-info-value">${data.uptime_days ? data.uptime_days.toFixed(1) + ' days' : 'N/A'}</div>
        </div>
        <div class="snmp-info-item">
            <div class="snmp-info-label">Description</div>
            <div class="snmp-info-value">${(data.description || 'N/A').substring(0, 50)}...</div>
        </div>
    `;
}

function renderCpuInfo(data) {
    const cpuDiv = document.getElementById('snmpCpu');
    const cpuValue = data.cpu_1min || data.cpu_5sec || 0;
    cpuDiv.innerHTML = `
        <div class="metric-value">${cpuValue}%</div>
        <div class="metric-label">CPU Usage</div>
    `;
}

function renderMemoryInfo(data) {
    const memDiv = document.getElementById('snmpMemory');
    memDiv.innerHTML = `
        <div class="metric-value">${data.memory_percent || 0}%</div>
        <div class="metric-label">Memory Used</div>
    `;
}

function renderInterfaceInfo(data) {
    const intDiv = document.getElementById('snmpInterface');
    const statusClass = data.status === 'up' ? 'up' : 'down';
    
    intDiv.innerHTML = `
        <div class="interface-stat">
            <div class="interface-stat-label">Status</div>
            <div class="interface-stat-value">
                <span class="status-indicator ${statusClass}"></span>
                ${data.status || 'unknown'}
            </div>
        </div>
        <div class="interface-stat">
            <div class="interface-stat-label">Bytes In</div>
            <div class="interface-stat-value">${formatBytes(data.bytes_in || 0)}</div>
        </div>
        <div class="interface-stat">
            <div class="interface-stat-label">Bytes Out</div>
            <div class="interface-stat-value">${formatBytes(data.bytes_out || 0)}</div>
        </div>
    `;
}

function formatBytes(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

function loadDemoData() {
    document.getElementById('snmpResults').style.display = 'block';
    
    renderDeviceInfo({
        hostname: 'Demo-Router-01',
        host: 'demo.example.com',
        uptime_days: 45.3,
        description: 'Cisco IOS Software, C2960 (Demo)'
    });
    
    document.getElementById('snmpCpu').innerHTML = `
        <div class="metric-value">35%</div>
        <div class="metric-label">CPU Usage (Demo)</div>
    `;
    
    document.getElementById('snmpMemory').innerHTML = `
        <div class="metric-value">67.5%</div>
        <div class="metric-label">Memory Used (Demo)</div>
    `;
    
    renderInterfaceInfo({
        status: 'up',
        bytes_in: 9876543210,
        bytes_out: 1234567890
    });
}
</script>
        
        <div class="alerts-container">
            <h3>🚨 Recent Alerts</h3>
            <div id="alertsList">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading alerts...</p>
                </div>
            </div>
            
            <div class="news-ticker-container">
                <div class="news-ticker-title">📰 Latest News</div>
                <div class="news-ticker" id="newsTicker">
                    <span>Loading latest news...</span>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        const API_BASE = 'http://localhost:8000/api/v1';
        
        let globalData = {};
        let currentRegion = 'all';
        
        document.addEventListener('DOMContentLoaded', function() {
            initDashboard();
            initMap();
        });
        
        async function initDashboard() {
            try {
                await loadStatistics();
                await loadCharts();
                await loadAlerts();
                await loadOfficeMarkers();
                await loadNewsTicker();
                
                setInterval(() => {
                    loadStatistics();
                    loadAlerts();
                    loadNewsTicker();
                }, 30000);
                
            } catch (error) {
                console.error('Initialization error:', error);
            }
        }
        
        async function loadStatistics() {
            try {
                const response = await fetch(`${API_BASE}/analytics/summary`);
                const data = await response.json();
                globalData = data;
                
                renderStatistics(data);
            } catch (error) {
                console.error('Error loading statistics:', error);
            }
        }
        
        function renderStatistics(data) {
            const statsGrid = document.getElementById('statsGrid');
            
            const stats = [
                {
                    icon: '🏢',
                    label: 'Total Offices',
                    value: data.global_health.total_offices,
                    trend: `${data.global_health.office_health}% Active`
                },
                {
                    icon: '🖥️',
                    label: 'Total Devices',
                    value: data.global_health.total_devices,
                    trend: `${data.global_health.online_devices} Online`
                },
                {
                    icon: '📈',
                    label: 'Average Uptime',
                    value: `${data.performance_metrics.average_uptime_pct}%`,
                    trend: 'Last 24h'
                },
                {
                    icon: '⚠️',
                    label: 'Active Alerts',
                    value: data.alerts.total,
                    trend: `${data.alerts.critical} Critical`
                }
            ];
            
            statsGrid.innerHTML = stats.map(stat => `
                <div class="stat-card">
                    <div class="icon">${stat.icon}</div>
                    <div class="label">${stat.label}</div>
                    <div class="value">${stat.value}</div>
                    <div class="trend">${stat.trend}</div>
                </div>
            `).join('');
        }
        
        async function loadCharts() {
            await loadPerformanceChart();
            await loadDeviceTypeChart();
            await loadRegionalChart();
            await loadNetworkChart();
        }
        
        async function loadPerformanceChart() {
            const response = await fetch(`${API_BASE}/analytics/trends?days=7`);
            const data = await response.json();
            
            const sampledData = data.trends.filter((_, index) => index % 6 === 0);
            
            const ctx = document.getElementById('performanceChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sampledData.map(d => new Date(d.timestamp).toLocaleDateString()),
                    datasets: [
                        {
                            label: 'CPU Usage (%)',
                            data: sampledData.map(d => d.avg_cpu_usage),
                            borderColor: 'rgb(255, 99, 132)',
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'Memory Usage (%)',
                            data: sampledData.map(d => d.avg_memory_usage),
                            borderColor: 'rgb(54, 162, 235)',
                            backgroundColor: 'rgba(54, 162, 235, 0.1)',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }
        
        async function loadDeviceTypeChart() {
            const response = await fetch(`${API_BASE}/analytics/device-distribution`);
            const data = await response.json();
            
            const ctx = document.getElementById('deviceTypeChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.distribution.map(d => d.type.charAt(0).toUpperCase() + d.type.slice(1)),
                    datasets: [{
                        data: data.distribution.map(d => d.count),
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.8)',
                            'rgba(54, 162, 235, 0.8)',
                            'rgba(255, 206, 86, 0.8)',
                            'rgba(75, 192, 192, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        
        async function loadRegionalChart() {
            const data = globalData;
            
            if (!data.regional_breakdown) return;
            
            const ctx = document.getElementById('regionalChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.regional_breakdown.map(r => r.region),
                    datasets: [{
                        label: 'Health Score',
                        data: data.regional_breakdown.map(r => r.health_score),
                        backgroundColor: 'rgba(102, 126, 234, 0.8)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }
        
        async function loadNetworkChart() {
            const response = await fetch(`${API_BASE}/analytics/trends?days=1`);
            const data = await response.json();
            
            const sampledData = data.trends.filter((_, index) => index % 2 === 0);
            
            const ctx = document.getElementById('networkChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sampledData.map(d => new Date(d.timestamp).toLocaleTimeString()),
                    datasets: [{
                        label: 'Latency (ms)',
                        data: sampledData.map(d => d.avg_latency_ms),
                        borderColor: 'rgb(153, 102, 255)',
                        backgroundColor: 'rgba(153, 102, 255, 0.1)',
                        yAxisID: 'y'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            position: 'left',
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        async function loadAlerts() {
            try {
                const response = await fetch(`${API_BASE}/analytics/alerts?limit=10`);
                const data = await response.json();
                
                renderAlerts(data.alerts);
            } catch (error) {
                console.error('Error loading alerts:', error);
            }
        }

        async function loadNewsTicker() {
            try {
                const response = await fetch(`${API_BASE}/external/news`);
                const data = await response.json();
                renderNewsTicker(data.news);
            } catch (error) {
                console.error("Error loading news:", error);
                const ticker = document.getElementById("newsTicker");
                ticker.innerHTML = "<span>Error loading news</span>";
            }
        }

        function renderNewsTicker(news) {
            const ticker = document.getElementById("newsTicker");
            if (!news || news.length === 0) {
                ticker.innerHTML = "<span>No news available</span>";
                return;
            }

            const newsHTML = news.map(article => `
                <a href="${article.url}" target="_blank">
                    ${article.title} — ${article.source}
                </a>
            `).join(" • ");

            ticker.innerHTML = `<span>${newsHTML}</span>`;
        }
        
        function renderAlerts(alerts) {
            const alertsList = document.getElementById('alertsList');
            
            if (alerts.length === 0) {
                alertsList.innerHTML = '<p style="text-align: center; color: #64748b;">No alerts at this time</p>';
                return;
            }
            
            alertsList.innerHTML = alerts.map(alert => {
                const timeAgo = getTimeAgo(new Date(alert.timestamp));
                
                return `
                    <div class="alert-item ${alert.severity}">
                        <div class="alert-header">
                            <span class="alert-title">${alert.type}</span>
                            <span class="alert-time">${timeAgo}</span>
                        </div>
                        <div class="alert-message">${alert.message}</div>
                        <div class="alert-location">
                            📍 ${alert.office_name}, ${alert.country} • ${alert.device_name}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            
            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + " years ago";
            
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + " months ago";
            
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + " days ago";
            
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + " hours ago";
            
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + " minutes ago";
            
            return "just now";
        }
        
        let map;
        let markers = [];
        
        function initMap() {
            map = L.map('map').setView([20, 0], 2);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors',
                maxZoom: 18
            }).addTo(map);
        }
        
        async function loadOfficeMarkers() {
            try {
                const response = await fetch(`${API_BASE}/offices`);
                const data = await response.json();
                
                markers.forEach(marker => map.removeLayer(marker));
                markers = [];
                
                data.offices.forEach(office => {
                    const marker = L.marker([office.coordinates.lat, office.coordinates.lng])
                        .addTo(map)
                        .bindPopup(`
                            <b>${office.name}</b><br>
                            ${office.city}, ${office.country}<br>
                            <small>Region: ${office.region}</small><br>
                            <button onclick="showOfficeDetails('${office.id}')" style="margin-top: 8px; padding: 4px 12px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                View Details
                            </button>
                        `);
                    
                    markers.push(marker);
                });
                
            } catch (error) {
                console.error('Error loading office markers:', error);
            }
        }
        
        async function showOfficeDetails(officeId) {
            try {
                const officeResponse = await fetch(`${API_BASE}/offices/${officeId}`);
                const office = await officeResponse.json();
                
                const devicesResponse = await fetch(`${API_BASE}/offices/${officeId}/devices`);
                const devicesData = await devicesResponse.json();
                
                const weatherResponse = await fetch(`${API_BASE}/external/weather/${officeId}`);
                const weatherData = await weatherResponse.json();

                const timeResponse = await fetch(`${API_BASE}/external/time/${officeId}`);
                const timeData = await timeResponse.json();
                
                const localTime = new Date(timeData.local_time).toLocaleString('en-US', {
                    hour12: false,
                    timeZoneName: 'short'
                });
                
                alert(`
Office: ${office.name}
Location: ${office.city}, ${office.country}
Region: ${office.region}
Local Time: ${localTime} (${timeData.timezone})
Devices: ${devicesData.total_devices}
Weather: ${weatherData.weather.description}, ${weatherData.weather.temperature}°C
                `.trim());
                
            } catch (error) {
                console.error('Error loading office details:', error);
                alert('Error loading office details');
            }
        }
        
        function filterRegion(region) {
            currentRegion = region;
            
            document.querySelectorAll('.region-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            if (region === 'all') {
                markers.forEach(marker => marker.addTo(map));
            } else {
                markers.forEach(marker => marker.addTo(map));
            }
        }
    </script>
</body>
</html>